---
description: Database access patterns and conventions for the @repo/db package
globs: packages/db/**/*
alwaysApply: false
---

# Database Package Guidelines

## Core Principle

**Never export the Prisma client directly.** All database access must go through model or service functions.

## Directory Structure

```
packages/db/
├── package.json       # Exports defined here (no barrel files)
├── src/
│   ├── client.ts      # Internal Prisma client (NOT exported)
│   ├── models/
│   │   └── {entity}.ts   # Single-entity CRUD operations
│   ├── services/
│   │   └── {feature}.ts  # Multi-entity business logic
│   └── validators/
│       └── {entity}.ts   # Zod schemas for validation
└── prisma/
    └── generated/        # Prisma generated types
```

## Models vs Services

- **Models** (`models/`): Single-entity operations, batch-friendly, pure CRUD
- **Services** (`services/`): Cross-entity orchestration, transactions, business logic

## Package Exports

```json
{
  "exports": {
    "./models/*": "./src/models/*.ts",
    "./services/*": "./src/services/*.ts",
    "./validators/*": "./src/validators/*.ts",
    "./types": "./prisma/generated/client.ts"
  }
}
```

## Model Pattern

Optimized for batch operations to avoid N+1 queries:

```typescript
// packages/db/src/models/{entity}.ts
import { prisma } from '../client';

export async function upsert{Entity}s(inputs: Input[]): Promise<Map<string, Entity>> {
  const unique = [...new Map(inputs.map(i => [i.key, i])).values()];
  
  const results = await Promise.all(
    unique.map(input => prisma.{entity}.upsert({
      where: { key: input.key },
      update: { ... },
      create: input,
      select: { id: true, key: true },
    }))
  );
  
  return new Map(results.map(r => [r.key, r]));
}
```

## Service Pattern

Orchestrates multiple models in a transaction:

```typescript
// packages/db/src/services/{feature}.ts
import { prisma } from '../client';
import { upsert{Entity}s } from '../models/{entity}';

export async function import{Feature}(data: Input[]) {
  return prisma.$transaction(async () => {
    const entityMap = await upsert{Entity}s(data);
    // ... more operations
    return results;
  });
}
```

## Usage in Applications

```typescript
import { importTestResults } from '@repo/db/services/import';
import { TestResultSchema } from '@repo/db/validators/submission';
```
